name: Release

on:
  push:
    branches: [main]

# Prevent multiple release workflows from running simultaneously
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Enable Auto-merge on Release PR
        # release-please-action@v4 outputs pr as a JSON object; extract the number
        if: steps.release.outputs.pr
        run: gh pr merge ${{ fromJSON(steps.release.outputs.pr).number }} --auto --squash --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build, test, publish to npm, and attach artifacts to the GitHub Release
  build-release:
    name: Build & Publish
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    permissions:
      contents: write
      id-token: write  # OIDC trusted publishing â€” no NPM_TOKEN secret required

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          # No registry-url â€” setup-node would write a .npmrc that overrides OIDC auth

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Publish to npm (OIDC trusted publishing)
        # publishConfig.provenance=true in package.json enables signed attestation.
        # NODE_AUTH_TOKEN cleared so OIDC credentials are used exclusively.
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ""

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: dist/**/*

      - name: Summary
        env:
          VERSION: ${{ needs.release-please.outputs.version }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
          SHA: ${{ github.sha }}
        run: |
          {
            echo "## ðŸŽ‰ Release ${VERSION} Published!"
            echo ""
            echo "**Tag:** \`${TAG_NAME}\`"
            echo "**Commit:** \`${SHA:0:7}\`"
            echo ""
            echo "### Distribution"
            echo "- [npm: @rishitank/holocron@${VERSION}](https://www.npmjs.com/package/@rishitank/holocron)"
            echo "- Claude Code: \`/plugin marketplace add rishitank/holocron\`"
          } >> "$GITHUB_STEP_SUMMARY"
